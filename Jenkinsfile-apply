pipeline{
    agent any
    environment{
        AWS_DEFAULT_REGION = "us-east-1"
    }
    stages {

        stage ('clear workspace'){
            steps{
                cleanWs()
            }
        }
        
        stage('Prepare SSH Key') {
            steps {
                echo "Copying SSH public key for Terraform Apply"
                sh 'cp /var/lib/jenkins/.ssh/id_ed25519.pub .'
                sh 'chmod 644 id_ed25519.pub'
                sh 'ls -l id_ed25519.pub'
            }
        }

        stage('download tfplan artifacts'){
            steps{
                echo "downloading artifacts"
                copyArtifacts(
                    projectName: 'terraform-ci-cd-pipeline',
                    selector: lastSuccessful()
                    // filter: 'tfplan, output_plan.txt, .terraform.lock.hcl'
                )
                sh 'ls -l'
            }
        }

        stage('Terraform Apply'){
            steps{
                echo "applying terraform"
                withCredentials([
                    string(credentialsId:'aws-access-key', variable:'AWS_ACCESS_KEY_ID'),
                    string(credentialsId:'aws-secret-key', variable:'AWS_SECRET_ACCESS_KEY')
                ]) {
                  sh 'terraform init -input=false' // re-initialize terraform
                  sh 'terraform apply tfplan'
                }
            }
        }
    }
}